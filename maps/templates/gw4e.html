{% extends 'base.html' %}
{% block title %}GW4E Dissemination Tool{% endblock %}
{% block script %}
{{ block.super }}
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
<!-- <script src="/static/js/bootstrap-treeview.js"></script> -->
<script src="/static/js/bstreeview.js"></script>
{% endblock %}
{% block style %}
{{ block.super }}
<link rel="stylesheet" href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
<!-- <link rel="stylesheet" href="/static/css/bootstrap-treeview.css"/> -->
<link rel="stylesheet" href="/static/css/bstreeview.css"/>
<style>
#map {
  height: 600px;
  border: 2px solid #1CABE3;
}
.list-group-item {
	padding-top: 0.5em;
	padding-bottom: 0.5em;
}
</style>
{% endblock %}
{% block content %}
<div class="container">
<h2 class="mt-3">Groundwater Mapping for Climate Resilient WASH</h2>	
<p>This website presents the results of the project "Groundwater Mapping for Climate Resilient WASH in arid and semi-arid areas of Ethiopia".
The project is funded by the European Union and managed by <a href="//www.unicef.org/ethiopia">Unicef Ethiopia</a>. Contracting parties are <a href="//www.acaciawater.com">Acacia Water</a> and <a href="//www.aquacon.info">Aquacon</a>
</p>
<p>Select a document or map below or click on the map on the right to open an interactive overlay map</p>
<div class="row row-fluid">
<div class="col">
<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-theme-tab" data-toggle="tab" href="#nav-theme" role="tab" aria-controls="nav-theme" aria-selected="true">Topic</a>
    <a class="nav-item nav-link" id="nav-cluster-tab" data-toggle="tab" href="#nav-cluster" role="tab" aria-controls="nav-cluster" aria-selected="false">Cluster</a>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-theme" role="tabpanel" aria-labelledby="nav-theme-tab">
  	<div id="tree1"></div>
  </div>
  <div class="tab-pane fade" id="nav-cluster" role="tabpanel" aria-labelledby="nav-cluster-tab">
  	<div id="tree2"></div>
  </div>
</div>
</div>
<div class="col">
	<div id="map" class="mt-5"></div>
</div>
</div>
</div>

<script>

function documentNodes(group) {
	return group.documents.map(doc => {
		return {
			text: doc.name,
			href: doc.url
		}
	})
}


function groupNodes(group) {
	return group.folders.map(folder => {
		return {
			text: folder.name,
			state: {expanded: false},
			nodes: [...documentNodes(folder), ...groupNodes(folder)]
		}
	})
}


function getTreeData(url) {
	return $.getJSON(url).then(response => {
		const tree = response.results.map(group => groupNodes(group))
		return tree
	})
}

$(function() {
	// initialize the map
	var map = L.map("map",{center:[10,40],zoom:4});
	var osm = L.tileLayer('//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
 		attribution: '&copy; <a href="//www.openstreetmap.org/copyright">OpenStreetMap</a>'
	});
	
	var stamen = L.tileLayer('http://tile.stamen.com/terrain/{z}/{x}/{y}.png', {
	   attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.',
	});
	stamen.addTo(map);
	
	$.getJSON('/static/clusters.json').then(data => {
		const clusters = L.geoJSON(data,{
            onEachFeature: (feature, layer) => {
                layer.bindTooltip(feature.properties.zonename)
                layer.setStyle({color: '#1CABE3'});
                layer.on('mouseover', () => {
                  layer.setStyle({ color: 'red'});
                  layer.bringToFront()
                })
                layer.on('mouseout', () => {
                  layer.setStyle({color:'#1CABE3'});
                })
                layer.on('click', () => {
                	window.open(`/map?cluster=${feature.properties.cluster}`);
                })
              }
		});
		clusters.addTo(map);
		map.fitBounds(clusters.getBounds());
	});

	
	getTreeData('/docs').then(tree => {
		const data = JSON.stringify(tree[0])
		$("#tree1").bstreeview({data: data})
	})

	getTreeData('/clus').then(tree => {
		const data = JSON.stringify(tree[0])
		$("#tree2").bstreeview({data: data})
	})
});
</script>
{% endblock content %}
