{% extends 'base.html' %}
{% load i18n admin_urls %}
{% block title %}{{map.name}} {% endblock %}
{% block style %}
{{ block.super }}
<link rel="stylesheet" href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
<link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.0.5/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.0.5/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="/static/css/leaflet.wmslegend.css"/>
<link rel="stylesheet" href="/static/css/maps.css"/>
{% endblock %}
{% block script %}
{{ block.super }}
<script src="//maps.googleapis.com/maps/api/js?key={{api_key}}" async defer></script>
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
<script src="//unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js"></script>
<script src="//unpkg.com/leaflet.markercluster@1.0.5/dist/leaflet.markercluster.js"></script>
<script src="//unpkg.com/esri-leaflet@2.1.1/dist/esri-leaflet.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="/static/js/leaflet.wmslegend.js"></script>
<script src="/static/js/betterwms.js"></script>
<script src="/static/js/xml2json.js"></script>
<script src="/static/js/maps.js"></script>
<script>

function getCookie(cookie) {
	const cookies = decodeURIComponent(document.cookie).split(';')
		.map(token => token.trim())
		.filter(token => token.startsWith(cookie));
	return cookies.length==1? cookies[0].substring(cookie.length+1): "";
}
	
async function addAllOverlays(groups, map, list) {
	let id = 0;
	let promises = [];
	$.each(groups, (name, layers) => {
		id++;
		const groupId = `group${id}`;
		let item = `<a class="list-group-item list-group-item-secondary" data-toggle="collapse" href="#${groupId}" aria-expanded="true" aria-controls="${groupId}">
		<i class="fas pr-3 fa-layer-group"></i><strong>${name}</strong></a>
		<div class="collapse show" id="${groupId}"></div>`;
		list.append(item);
		// Allow user to sort layers in group list
		$(`#${groupId}`).sortable({
			update: function(event,ui) {
				// copy text of divs with a data-toggle attribute (displayName of layers) to array
				const keys = $(this).find('div[data-toggle]').toArray().map(e => e.innerText);
				console.debug(keys);
				$.post('reorder/',JSON.stringify(keys)).then(()=> {
					sortOverlays(overlayLayers,keys);
				});
			}
		});
		addOverlays(map, $(`#${groupId}`), layers)
			.then(p => {
				promises.push(p);
			});
	});
	return promises;
}

$(function() {
	// setup ajax to use csrf token in posts
	$.ajaxSetup({
		beforeSend: function(xhr) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
		}
	});

	// initialize the map
	const options = {{options|safe}};
	const map = initMap('map',options,{{map.id}});
	
	// set the extent of the map
	const extent = {{extent}};
	if (extent.length === 4) {
		const bounds = L.latLngBounds([extent[1],extent[0]],[extent[3],extent[2]]);
		map.fitBounds(bounds);
	}

	// load overlays
	const groups = {{map.groups|safe}};
	const list = $("#list");
	overlayLayers = [];
	addAllOverlays(groups, map, list).then(() => {
// 	 	$("#listwrapper").height($("#map").height());
	});

{% if series %}
 	const series = {{series|safe}};
	addItems(map, $("#series"), series)
		.then(items => {
			$("#itemcount").html(`${items.length}`);
		});
{% endif %}
});

</script>
{% endblock %}
{% block content %}
<div class="full container-fluid">
	<div class="full row row-fluid">
		<div id="map" class="full col-sm-10"></div>
		{% block list %}
<!-- 		<ul id="list1" class="list-group scroll col-sm-2 pr-0"> -->
<!-- 		<li class="list-group-item">one</li> -->
<!-- 		<li class="list-group-item">two</li> -->
<!-- 		<li class="list-group-item">three</li> -->
<!-- 		</ul> -->
		<div id="listwrapper" class="col-sm-2 pr-0">
			<ul id="list" class="list-group scroll pr-0">
				{% if series %}
				<a class="list-group-item active" data-toggle="collapse" href="#series" aria-expanded="true" aria-controls="series">
					<i class="fas pr-3 fa-chart-line"></i>{%trans "Timeseries"%}<span id="itemcount" class="float-right badge badge-light">...</span>
				</a>
				<div class="collapse hide" id="series">
				</div>
				{% endif %}
			</ul>
		</div>
		{% endblock list %}
	</div>
</div>
{% endblock %}