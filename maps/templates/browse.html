{% extends 'base.html' %}
{% load thumbnail %}
{% block title %}GW4E Dissemination Tool{% endblock %}
{% block script %}
{{ block.super }}
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
<script src="/static/js/bstreeview.js"></script>
{% endblock %}
{% block style %}
{{ block.super }}
<link rel="stylesheet" href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
<link rel="stylesheet" href="/static/css/bstreeview.css"/>
<style>

#preview {
  height: 638px;
  background-color: white;
  border: 1px solid lightgray;
  border-radius: 4px;
}

.preview {
  max-height: 638px;
  max-width: 100%;
  display: block;
  margin: auto;
}

.center {
}

#tree1 {
  height: 600px;
  max-height: 600px;
  overflow-y: auto;
}

.list-group-item {
	padding-top: 0.5em;
	padding-bottom: 0.5em;
}

.container {
}

</style>
{% endblock %}
{% block content %}
<div class="container">
<h2 class="mt-3">Groundwater Mapping for Climate Resilient WASH</h2>	
<p>This website presents the results of the project "Groundwater Mapping for Climate Resilient WASH in arid and semi-arid areas of Ethiopia".
The project is funded by the European Union and managed by <a href="//www.unicef.org/ethiopia">Unicef Ethiopia</a>. Contracting parties are <a href="//www.acaciawater.com">Acacia Water</a> and <a href="//www.aquacon.info">Aquacon</a>
</p>
<p>Select a document or map below</p>
<div class="row row-fluid">
<div class="col col-3">
    <select id="cluster" class="custom-select" onchange="changeCluster()">
	    <option value="0" selected>All clusters</option>
	    <option value="1">Cluster 1 - Wag Himra</option>
	    <option value="2">Cluster 2 - Afar</option>
	    <option value="3">Cluster 3 - Siti</option>
	    <option value="4">Cluster 4 - Liben</option>
	    <option value="5">Cluster 5 - Bale</option>
	    <option value="6">Cluster 6 - Borena</option>
	    <option value="7">Cluster 7 - Wolayta</option>
	    <option value="8">Cluster 8 - South Omo</option>
    </select>
  	<div id="tree1"></div>
</div>
<div class="col col-9">
	<div id="preview"></div>
</div>
</div>
</div>

<script>

function documentNodes(group) {
	return group.documents.map(doc => {
		return {
			text: doc.name,
			href: doc.url,
			img: doc.img
		}
	})
}


function groupNodes(group) {
	return group.folders.map(folder => {
		return {
			text: folder.name,
			nodes: [...documentNodes(folder), ...groupNodes(folder)]
		}
	})
}


function getTreeData(url) {
	return $.getJSON(url).then(response => {
		const tree = response.results.map(group => groupNodes(group))
		return tree[0]
	})
}

function loadTree(cluster) {
	let url = '/docs'
	if (cluster) {
		url += `?cluster=${cluster}`
	}
	getTreeData(url).then(tree => {
		$("#tree1").bstreeview({data: tree})
		$("#tree1 .list-group-item").on("mouseenter", function(sender, args) {
			const thumb = $(this).attr('thumb')
			let html = ''
			if (thumb) {
				html = `<img class="preview" src="${thumb}">`
				const link = $(this).find("a[href]").first()
				if (link) {
					const href = link.attr("href")
					html = `<a href="${href}" title="Click to inspect or download">${html}</a>`
				} 
			}
			else {
				html = '<p class="d-flex justify-content-center align-items-center h-100"><i>(No preview available)</i></p>'
			}
			$("#preview").html(html)
		})
	})
}

function changeCluster() {
	const cluster = $("#cluster").val()
// 	console.log(`cluster${cluster}`)
// 	loadTree(cluster)
	location.reload()
}

$(function() {
	
	loadTree($("#cluster").val())
	
});
</script>
{% endblock content %}
